# 08. Class 文件

Java 的口号 "一次编写, 到处运行 (Write Once，Run Anywhere)" 的基础: JVM 和 所有平台都统一支持的程序存储格式 -- 字节码 (Byte Code)。 只要在对应的平台安装对应的 JVM, 将我们编写的源码编译为 Class 文件, 就能达到了异常编写, 导出运行的目标。 中间的所有细节有不同平台的 JVM 进行处理即可。

## 8.1 Java 文件到 class 文件

我们编写的 Java 源代码需要借助 Javac 编译器, 才能编译成 JVM 能识别的字节码文件, 流程如图所示

![Alt 'JavaSourceFile2ClassFile'](https://raw.githubusercontent.com/PictureRespository/Java/main/JVM/JavaSourceFile2ClassFile.png)


Javac 是一种编译器，能**将一种语言规范转化成另外一种语言规范，通常编译器都是将便于人理解的语言规范转化成机器容易理解的语言规范**，如 C/C++ 或者汇编语言都是将源代码直接编译成目标机器码，这个目标机器代码是 CPU 直接执行的指令集合。这些指令集合也就是底层的一种语言规范。

Javac 的编译器也是将 Java这 种对人非常友好的编程语言编译成对对所有机器都非常友好的一种语言。这种语言不是针对某种机器或某个平台。**怎么消除不同种类，不同平台之间的差异这个任务就有 JVM 来完成**，而 Javac 的任务就是将 Java 源代码语言转化为 JVM 能够识别的一种语言，然后由 JVM 将 JVM 语言再转化成当前这个机器能够识别的机器语言。

Javac 的任务就是将 Java 源代码编译成 Java 字节码，也就是JVM能够识别的二进制代码，从表面看是将 .java 文件转化为 .class 文件。而实际上是将 Java 源代码转化成一连串二进制数字，这些二进制数字是有格式的，只有 JVM 能够真确的识别他们到底代表什么意思。


编译器把一种语言规范转化为另一种语言规范的这个过程需要哪些步骤？回答这个问题需要参照《编译原理》，总结过程如下:

1）词法分析：读取源代码，一个字节一个字节的读进来，找出这些词法中我们定义的语言关键词如：if、else、while 等，识别哪些 if 是合法的哪些是不合法的。这个步骤就是词法分析过程。

词法分析的结果：就是从源代码中找出了一些规范化的 token 流，就像人类语言中，给你一句话你要分辨出哪些是一个词语，哪些是标点符号，哪些是动词，哪些是名词。

2）语法分析：就是对词法分析中得到的 token 流进行语法分析，这一步就是检查这些关键词组合在一起是不是符合 Java 语言规范。如 if 的后面是不是紧跟着一个布尔型判断表达式。

语法分析的结果：就是形成一个符合 Java 语言规定的抽象语法树，抽象语法树是一个结构化的语法表达形式，它的作用是把语言的主要词法用一个结构化的形式组织在一起。这棵语法树可以被后面按照新的规则再重新组织。

 3）语义分析：语法分析完成之后也就不存在语法问题了，语义分析的主要工作就是把一些难懂的，复杂的语法转化成更简单的语法。就如难懂的文言文转化为大家都懂的百话文，或者是注释一下一些不懂的成语。

语义分析结果：就是将复杂的语法转化为简单的语法，对应到 Java 就是将 foreach 转化为 for 循环，还有一些注释等。最后生成一棵抽象的语法树，这棵语法树也就更接近目标语言的语法规则。

4）字节码生成：将会根据经过注释的抽象语法树生成字节码，也就是将一个数据结构转化为另外一个数据结构。就像将所有的中文词语翻译成英文单词后按照英文语法组装成英文语句。代码生成器的结果就是生成符合 Java 虚拟机规范的字节码。这个过程中的需要的组件如下图所示

![Alt 'JavacHandlerProcesses'](https://raw.githubusercontent.com/PictureRespository/Java/main/JVM/JavacHandlerProcesses.png)

从上面的描述中我们知道编译就是将一种语言通过分析分解，再按照一定的方式先形成一个简单的框架（将 Java 源文件的字节流转化为对应的 token 流）然后在通过详细的分析按照一定的规定在这个框架里添加东西使这个token流形成更加结构化的语法树（就是将前面生成的token流中的一个个单词组装成一句话），但是这棵树离我们的目标— Java 字节码还有点差距，所以再进行语义分析使那颗粗糙的树更加完整完善（给类添加默认的构造函数，检查变量在使用前有没有初始化，检查操作变量类型是否匹配），然后 Javac 编译器调用 com.sun.tools.javac.jvm.Gen 类遍历这棵语法树将 Java 方法中的代码块转换成符合 JVM 语法的命令形式的二进制数据。按照 JVM 的文件组织格式将字节码输出到以 class 为扩展名的文件中，也就是生成最终的 Java 字节码。**词法分析就是将关键词组织成 token 流即检查源码中的的关键词是否真确并组织成 token 流，而语法分析就是检查源码是否符合 Java 语法规范并将词组成语句。语义分析就是简化复杂的添加缺少的，检查变量类型是否合法。代码生成器就是遍历这棵树生成符合 JVM 规范的代码**

# 8.1 Class 类文件的结构