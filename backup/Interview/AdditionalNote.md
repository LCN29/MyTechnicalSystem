
## 限流

限流中有两个概念
1. 阈值: 在一个单位时间内允许的请求量
2. 拒绝策略: 超过阈值的请求的拒绝策略，常见的拒绝策略有直接拒绝、排队等待等

窗口算法
桶算法

固定窗口算法 (计数器算法)
通过一个支持原子操作的计数器来累计 1 秒内的请求次数，当 1 秒内计数达到限流阈值时触发拒绝策略。每过 1 秒，计数器重置为 0 开始重新计数。

实现简单, 但是存在一些问题
比如要求是 1s 内只能请求 2 次, 那么可能出现 2 个 1s 的区间, 可以出现 4 次情况

第一个 1s, 500ms 没有请求, 后面 500ms 请求 2 次, 
下一个 1s 前面 500ms 请求了 2 次,
这样导致了在 1s 内可以出现 4 次的情况

滑动窗口算法
将时间窗口, 的开始时间定在第一次请求的时候。
第一次请求进来, 存下开始时间, 请求次数加 1, 下次请求进来

提前生命一组世界窗口, 窗口里面存放 窗口的时间 + 请求的次数
1. 请求进来, 获取到当前的世界, 根据当前的时间 和 窗口的声明数量 和 窗口的超时时间, 求出当前应该在哪个窗口 (当前的时间 % 超时时间/(超时时间/ 窗口数量))
2. 遍历所有的窗口, 当前的时间 - 窗口的时间大于 窗口超时时间, 更新窗口的时间为当前时间, 请求次数为 0
3. 遍历窗口中, 定位到对应的窗口了, 请求次数 + 1
4. 遍历所有的窗口中, 计算出所有窗口的请求次数，根据这个请求次数判断是否超次数了

滑动日志算法
记录下所有的请求时间点，新请求到来时先判断最近指定时间范围内的请求数量是否超过指定阈值，由此来确定是否达到限流
限流比较准确，但是因为要记录下每次请求的时间点，所以占用的内存较多

漏桶算法
请求到来后放到一个漏桶 (队列)中, 消费者按照固定的频率从队列中取请求进行处理，比如限制 1s 2qps, 那么取的频率为 1s/2 = 500ms,
缺点, 如果同时来了 2 个请求, 这 2 个请求没法同时进行消费, 会按照 500ms/个的频率处理

令牌桶算法

系统服务按照指定频率向桶（容器）中添加令牌, 如 QPS 为 2，每 500ms 向桶中添加一个令牌，如果桶中令牌数量达到阈值，则不再添加
请求进来, 需要先从桶中拿取一个令牌，取到令牌则继续执行，没取到, 触发拒绝策略，可以是超时等待，也可以是直接拒绝本次请求，由此达到限流目的。

如果按照指定间隔添加令牌，那么需要开一个线程去定时添加，如果有很多个接口很多个 RateLimiter 实例，线程数会随之增加，
Google Guava 在每次令牌获取时才进行计算令牌是否足够的。它通过存储的下一个令牌生成的时间，和当前获取令牌的时间差，再结合阈值，去计算令牌是否足够，同时再记录下一个令牌的生成时间以便下一次调用

https://juejin.cn/post/7075137592265539614

## Redis 哨兵模式

哨兵功能
监控 (Monitoring): 哨兵会不断地检查主节点和从节点是否运作正常
自动故障转移 (Automatic failover): 当主节点不能正常工作时, 哨兵会开始自动故障转移操作, 它会将失效主节点的其中一个从节点升级为新的主节点, 并让其他从节点改为复制新的主节点
配置提供者 (Configuration provider): 客户端在初始化时, 通过连接哨兵来获得当前 Redis 服务的主节点地址
通知 (Notification): 哨兵可以将故障转移的结果发送给客户端

过程
主观下线
客观下线
选举领导哨兵节点
故障转移

心跳阶段中, 某个哨兵检测到某个节点超过一定时间没有回复, 哨兵节点就会将其进行**主观下线**, 这个节点为从节点或哨兵节点, 就结束了

哨兵节点主观下线了主节点, 这时会发送命令请求其他哨兵节点, 当前主节点是否超时了, 判断主节点下线的哨兵数量达到一定数值, 则对该主节点进行**客观下线**

当主节点被判断客观下线以后, 各个哨兵节点会进行协商, 选举出一个领导者哨兵节点, 并由该领导者节点对其进行故障转移操作
选择过程
> 1 某个节点发送请求到其他哨兵节点, 判断自己能否成为领导节点
> 2 当其他哨兵收到此命令时，可以同意或者拒绝它成为领导者
> 3 当某个节点发先自己的选举票数 >= 哨兵/2 + 1， 成为领导节点, 如果没有超过，继续选举

选举出的领导者哨兵, 开始进行故障转移操作, 该操作大体可以分为 3 个步骤
> 1 按照规则从从节点中选举一个作为主节点
> 2 更新主从状态: 通过 slaveof no one 命令, 让选出来的从节点成为主节点, 并通过 slaveof 命令让其他节点成为其从节点
> 3 将已经下线的主节点, 设置为新的主节点的从节点, 当其重新上线后, 它会成为新的主节点的从节点

脑裂, 
原本的主节点, 可能因为网络问题, 导致和哨兵出现通讯问题, 哨兵重新选举了另一个主节点, 出现了 2 个从节点
解决: min-slaves-to-write 1 需要至少多少个从节点才能进行写操作, 


## 索引的建立规则
