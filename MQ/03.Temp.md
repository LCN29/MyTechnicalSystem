
# Confirm 确认消息机制

Publisher 投递消息后, 如果 Broker 收到消息, 则会返回给 Publisher 一个应答。
Publisher 进行应答接收, 用来确定这条小时是否正常的发送到 Broker。

这种方式是消息可靠性投递的核心保障。

Spring Cloud Stream 的 Confirm 可以看这里 

[spring-cloud-stream-binder-stream](https://github.com/spring-cloud/spring-cloud-stream-binder-rabbit#publisher-confirms)

正常的使用
```Java

// 1. 指定消息投递模式, 消息确认模式
channel.confirmSelect();

// 2. TODO 通过这个 channel 进行消息发送 channel.basicPublish();

// 3. 添加消息确认监听
channel.addConfirmListener(new ConfirmListener() {

    @Override
    public void handleNack(long deliveryTag, boolean multipe) throws IOException {
        // 消息投递失败回调
    }

    @Override
    public void handleAck(long deliveryTag, boolean multiple) throws IOException {
        // 消息投递成功回调
    }
});
```

# Return 消息机制

Return 消息机制用于处理一些不可路由的消息。
在某些情况下, 发送消息的时候, 当前的 Exchange 不存在或者指定的 Routing Key 路由不到，这个时候如果监听这种不可达的消息，就要用到 Return Listener。

Mandatory, 如果为 True, Return Listener 可以接收到路由不可达的消息，False, Broker 自动删除这个消息。

```java
channel.addReturnListener(new ReturnListener() {

    @Override
    public void handleReturn(int replyCode, String replyText, String exchange, String routingKey, AMQP.BasicProperties     properties, byte body) throws IOException {
        // replyCode 错误码 replyText 错误提示
        // return 监听
    }    

});

channel.basicPublish(exchange, routingKey, mandatory(true/false), props, messageBody);
```

# 消费端限流

RabbitMQ 提供了一种 Qos (服务质量保证) 功能, 即在非自动确认消息的前提下, 如果一定数目的消息 (通过基于 consumer 或者 channel 设置 Qos 的值) 未被确认, 不进行消费新的消息。

```java
// prefetchSize 消息的大小限制，0 表示不限制
// prefetchCount 每次获取多少条消息
// gloabl 是否应用于 Channel 级别 true 为应用, false 不应用, 只作用在 Consumer
channel.basicQos(int prefetchSize int prefetchCount, boolean global);

```