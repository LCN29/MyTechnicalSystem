# 2 RabbitMQ 的高级特性

## 2.1 消息的百分百投递

### 2.1.1 生产端的可靠性投递

大体的流程
> 1. 发送端消息的成功发出
> 2. MQ 节点 (Broker 成功收到消息
> 3. 发送端收到 MQ 节点的确认应答
> 4. 完善的消息补偿机制

#### 2.1.2 常用的解决方案

**方案一**  
消息落库, 对消息状态进行打标。  
同时搭配定时任务对库中未成功的消息进行**有次数限制的**重试, 对重试次数超过限制的进行迁移等特殊操作。

> 1. 将消息先落库, 默认状态为 0, (记录重试次数为 0, 或者当前的落库时间)
> 2. 将消息发送到 MQ Broker
> 3. 监听到 MQ Broker 的 confirm, 更新消息状态为 1
> 4. 存在特殊情况导致消息的状态为 0, 重启, 处理失败等
> 5. 定时任务对库中的消息进行重试, 根据重试次数的只有次数没达到上限就能继续重试, 根据落库时间的, 只要当前的时间不超过落库时间多长时间也能继续重试
> 6. 对重试次数达到上限或者落库时间和当前时间超过多长时间, 将消息迁移到另一张表或其他的特殊处理


**方案二**  
消息延迟投递, 做第二次确认, 回调检查。




