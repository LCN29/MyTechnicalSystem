# Redis 编码


## Redis 数据结构

> 1. strings 
> 2. hashes
> 3. lists
> 4. sets
> 5. sorted sets
> 6. bitmaps 位图
> 7. hyperloglogs 一种用于计算唯一事物的概率数据结构, 大数据量的基数统计 {1,2,1,4,5} 
> 8. geospatial indexes 一种用于存储地理位置的数据结构
> 9. streams 类似于消息队列的完善实现, 死信, 消费组, 消息转移等

## Redis 编码

strings, hashes 等 Redis 对外的数据结构。

这些数据结构, 在 Redis 内部, 会根据存储的内容和场景选择不同的实现，这些实现在 Reids 中叫做 内部编码。

有点类似于 接口 和 具体的实现类的关系。
在 Redis 中 总共有 12 种不同的编码方式, 基本 5 种常用的数据结构都可以由 2 种以上的编码进行实现。

OBJ_ENCODING_RAW
OBJ_ENCODING_INT
OBJ_ENCODING_HT
OBJ_ENCODING_ZIPMAP
OBJ_ENCODING_LINKEDLIST
OBJ_ENCODING_ZIPLIST
OBJ_ENCODING_INTSET
OBJ_ENCODING_SKIPLIST
OBJ_ENCODING_EMBSTR
OBJ_ENCODING_QUICKLIST
OBJ_ENCODING_STREAM
OBJ_ENCODING_LISTPACK

strings -> int embstr, raw
hashs -> ziplist, hashtable
list -> 早期 ziplist, linkedlist 3.2 版本后 quicklist
set -> intset, hashtable
sorted sets -> ziplist, skiplist


## Sds

### C语言 char[]

C 语言本身没有字符串类型 (只能用字符数组 char[] 实现)。

在 C 语言中通过 char[] 数组实现字符串的功能, 会涉及到的一些问题

> 1. C字符串不记录自身长度和空闲空间，容易造成缓冲区溢出
> 2. 字符串长度变化了，需要重新分配内存
> 3. 需要获取到长度, 就行进行遍历 O(n), C 语言的数组没有提供 len 或者 len() 方法直接获取长度
> 4. C语言中通过 **\0** 代表字符串的结束, 存储其他的格式的内存，二进制表示的音频图片等, 可能会出现问题，也就是二进制不安全

struct sds {

    int len;// buf 中已占用字节数, 可以看做是使用的长度
    int free;// buf 中剩余可用字节数, 可以看做是剩余的长度
    char buf[];// 数据数组
}

3.2 版本之前 redis 对字符串的实现

空间预分配和惰性空间释放


Redis 是一款基于内存的数据库, 那么 内存是极其重要的。那么上面的 sds 从内存上考虑有什么问题吗?

表示长度和剩余长度的 len / free, 用的是 int 修饰的, 最大值为 2147483647, 正常情况下字符串的长度会超过这个吗？ 应该不会, 那么是否可以
用 2 个字节的 uint16_t (Java 层面的 short, 最大值为 32768) 进行存储呢?

既然可以用 2 个字节, 那么 1 个字节呢, 不足一个字节的呢？

所以在 Redis 3.2 后, 对 sds 更进一步的细化, 分成了 5 种实现, 基于 1, 2, 4, 8 个字节的实现 + 基于 5 位的实现, 同时在结构体内追加了一个 1 个字节的 flags 表示这个结构体的类型

```c
struct __attribute__((__packed__))sdshdr8 {
    uint8_t len;
    uint8_t alloc;
    unsigned char flags;
    char buf[];
}

struct __attribute__((__packed__))sdshdr16 {

    uint16_t len;
    uint16_t alloc;
    unsigned char flags;
    char buf[];

}

// 几乎不会使用到, 外部使用时, 即使一个很小的字符串也会先转换为 8 位存储
// 只在内部源码中别使用到
struct __attribute__((__packed__))sdshdr5 {

    /** flags 只有 5 种情况， 3 位存储够了 */
    /** 把长度和类型放在一起 */
    /** 低3位存储类型, 高5位存储长度 */
    unsigned char flags; 

    char buf[];
}
```

平时在使用字符串时, 字符串的长度一般会多长呢?  超过 32768 的可能大吗？


## String

int embstr raw

int -> long

embstr raw 本质就是 sds, 不同的时， 在 Redis 声明 value 的对象时, value 对象 和 sds 之间一起分配内存的


https://blog.csdn.net/u013099854/article/details/115399466

https://www.cnblogs.com/sunchong/p/11924295.html
https://www.cnblogs.com/yinbiao/p/10740212.html





