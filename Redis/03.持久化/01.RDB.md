# 1 RDB

RDB 是 Redis 默认的持久化方案。当满足一定条件的时候, 会把当前内存中的数据写入磁盘, 生成一个快照文件 **dump.rdb**。Redis 重启会通过加载 dump.rdb 文件恢复数据。  


## 1.1 触发 RDB 

### 1.1.1 配置规则触发

在 redis.conf 的 SNAPSHOTING, 其中定义了触发把数据保存到磁盘的触发频率 (如果不需要 RDB 方案, 注释掉 save 或配置成空字符串 "" 即可)。

```
save 900 1  # 900 秒内至少有一个 key 被修改 (包括添加)
save 300 10 # 300 秒内至少有 10 个 key 被修改
save 60 100 # 60 秒内至少有 100 个 key 被修改
```

上面的配置是不冲突的, 只要满足任意一个都会触发。

RDB 文件相关的配置

```
dir    ./               # rdb 文件路径, 默认在启动目录下
dbfilename  dump.rdb    # rdb 文件名称
rdbcompression yes      # 开启压缩可以节省存储空间, 但是会消耗一些 CPU 的计算时间, 默认开启
rdbchecksum  yes        # 使用 CRC64 算法来进行数据校验, 但是这样会增加大约 10% 的性能消耗, 默认开启
```

### 1.1.2 通过命令

Redis 提供了 2 条命令 **save** 和 **bgsave** 可以用来手动触发数据保存。

save: 在生成快照的时候会阻塞当前 Redis 服务器, Redis 不能处理其他命令。如果内存中的数据比较多, 会造成 Redis 长时间阻塞。生产中不建议使用这个命令。  
bgsave: Redis 进程通过 fork 操作创建出一个子进程 (copy-on-write)。 RDB 持久化过程有子进程负责, 完成后自动结束。它不会记录 fork 之后的命令, 阻塞值发生在 fork 阶段, 一般时间很短。

可以通过 **lastsave** 命令查看最近一次生成快照的时间。

## 1.2 RDB 文件结构


如图是 RDB 的文件结构, 分析如下:

**第一部分**: 固定为 ”REDIS“ 这 5 个字符, 占用 5 个字节, 标识这是一个 Redis 可以处理的文件。

**第二部分**: RDB_VERSION, 标识当前的 RDB 文件的版本号, 占用 4 个字节。

**第三部分**: AUX_FIELD_KEY_VALUE_PAIRS, 这个属性不是简单的属性, 可以看出是 8 个 key-value 公共组成的一个属性值
> 1. key 为 redis-ver, value 为当前 Redis 的版本
> 2. key 为 redis-bit, value 为当前 Redis 的位数, 64 位 / 32 位
> 3. key 为 ctime, value 为 RDB 创建时的时间戳
> 4. key 为 used-mem, value 为 dump 时 Redis 占的内存, 单位字节
> 5. key 为 aof-preamble, value 为是否开启了 aof/rdb 的混合使用
> 6. key 为 repl-steam-db, value 和主从复制相关
> 7. key 为 repl-id, value 和主从复制相关
> 8. key 为 repl-offset, value 和主从复制相关 


https://zhuanlan.zhihu.com/p/276319001