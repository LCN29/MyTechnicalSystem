# 2 事件处理


Redis 服务器是典型的事件驱动程序，而事件又分为文件事件 (socket 的可读可写事件) 与时间事件 (定时任务) 两大类。2 者都会被封装到 aeEventLoop:

```C
typedef struct aeEventLoop {

    /** 事件循环是否结束 */
    int stop; 

    /** 文件事件数组，存储已经注册的文件事件 */
    aeFileEvent *events; 

    /** 存储被触发的文件事件, Redis 有多个定时任务，因此理论上应该有多个时间事件，多个时间事件形成链表 */
    aeFiredEvent *fired; 
    
    /** 为时间事件链表头节点 */
    aeTimeEvent *timeEventHead; 

    /** 指向的数据类型为 aeApiState, 是对当前使用的多路复用模型的进一步包装 */
    void *apidata;
    
    /** Redis 服务器需要阻塞等待文件事件的发生，进程阻塞之前会调用 beforesleep 函数，进程因为某种原因被唤醒之后会调用 aftersleep 函数 */
    aeBeforeSleepProc *beforesleep; 
    aeBeforeSleepProc *aftersleep;

} aeEventLoop;
```

Redis 底层可以使用 4 种 I/O 多路复用模型 (select, epoll, keueue, evport), apidata 是对这 4 种模型的进一步封装。

注: Redis 使用了一个称为 "A simple event-driven programming library" 的自制异步事件库, 简称 ”ae“, 所以下面看到的很多 ae 开头的基本都可以认为是这个库的功能。



## 2.1 文件事件

Redis 客户端和服务端之间是通过 socket 通讯的, socket 的可读可写事件就是我们常说的文件事件。   
对于 socket 读写操作由阻塞和非阻塞之分。
> 1. 阻塞: 一个线程 (进程) 处理一条网络连接的读写操作, 为了能同时处理多条网络连接, 通常会直接采用多线程或多进程
> 2. 非阻塞: 使用目前比较成熟的 I/O 多路复用模型, Redis 就是使用这种方法处理请求的, 其会根据不同的系统, 从 4 中模型中选择一个。

以 epollo 为例。  
epoll 是 Linux 内核为处理大量并发网络连接而提出的解决方案, 能显著提升系统 CPU 利用率。  
epoll 的使用非常简单, 总共只有 3 个 API:
> 1. epoll_create 函数创建一个 epoll 专用的文件描述符, 用于后续 epoll 相关 API 调用
> 2. epoll_ctl 函数向 epoll 注册, 修改或删除需要监控的事件
> 3. epoll_wait 函数会阻塞进程, 直到监控的若干网络连接有事件发生

### 2.1.1 epoll_create

```C
int epoll_create(int size)
```
入参 size: 通知内核程序期望注册的网络连接数目，内核以此判断初始分配空间大小。 在 Linux 2.6.8 版本以后, 内核动态分配空间, 此参数会被忽略。
出参 : 返回 epoll 专用的文件描述符。注不再使用时应该及时关闭此文件描述符。

### 2.1.2 epoll_ctl

```C
int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)
```
入参
epfd：函数 epoll_create 返回的 epoll 文件描述符
op：需要进行的操作，EPOLL_CTL_ADD 表示注册事件， EPOLL_CTL_MOD 表示修改网络连接事件，EPOLL_CTL_DEL 表示删除事件
fd：网络连接的socket文件描述符
event：需要监控的事件

```C
struct epoll_event { 
    __uint32_t events; 
    epoll_data_t data; 
};

typedef union epoll_data { 
    void *ptr; 
    int fd; 
    __uint32_t u32; 
    __uint64_t u64; 
} epoll_data_t;
```

其中 events 表示需要监控的事件类型，比较常用的是 EPOLLIN 文件 描述符可读事件，EPOLLOUT 文件描述符可写事件；data 保存与文件描 述符关联的数据。

函数执行成功时返回0，否则返回-1，错误码设置在变量 errno 中

### 2.1.3 epoll_wait

```C
int epoll_wait(int epfd,struct epoll_event * events,int maxevents,int timeout)

```
epfd：函数 epoll_create 返回的epoll文件描述符； 
epoll_event：作为输出参数使用，用于回传已触发的事件数组； 
maxevents：每次能处理的最大事件数目

timeout：epoll_wait函数阻塞超时时间，如果超过timeout时间还没 有事件发生，函数不再阻塞直接返回；当timeout等于0时函数立即返 回，timeout等于-1时函数会一直阻塞直到有事件发生

函数执行成功时返回0，否则返回-1，错误码设置在变量 errno 中